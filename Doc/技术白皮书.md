# 技术白皮书（MVP 架构）

---

## 1. Data & Ingestion

### 数据来源

- **餐厅数据**：开放数据接口、爬虫采集、合作餐厅提供的菜单与信息。
- **菜品信息**：菜名、描述、标签、过敏原、价格、餐厅 ID、图片。

### 数据处理

- **清洗**：统一格式、去重、处理缺失字段。
- **规范化**：标签与过敏原映射成标准字典（多语言支持）。
- **拼接文本**：将 `name + desc + tags + allergens` 拼成语义输入。
- **批量嵌入**：调用向量服务生成菜品向量。
- **入库**：餐厅与菜品元数据存入 MongoDB；向量写入 FAISS 索引。

---

## 2. Vector Service

### 架构

- 框架：FastAPI (Python)
- 模型：`bge-m3` 或 `multilingual-e5-large`（中/英/法）
- 索引类型：
  - MVP：`HNSWFlat`（支持增量更新，适合 ≤10k 菜品）
  - 扩容：`IVFPQ`（≥100k 菜品，节省内存）

### 核心 API

- `POST /embed`：文本数组 → 向量
- `POST /index/upsert`：增量写入（id + vector），同时更新 id→vector 映射
- `POST /search`：向量检索 → 返回候选 `{id, score}`（原始分数，未归一化）
- `POST /vector/get`：按 id 批量读取向量（用于用户画像构建/更新）
- `POST /index/save|load`：索引与映射持久化（本地或对象存储）

### 推荐逻辑

- 检索 topK（默认 100）
- 结合预算/半径/过敏原做二次过滤
- **MMR 去冗余** 保证多样性
- 返回前 10 个结果

---

## 3. Backend Server

### 技术栈

- **框架**：Express + TypeScript
- **数据库**：MongoDB（Mongoose ODM）
- **鉴权**：JWT + Cookie
- **通信**：调用 Python Vector Service

### 数据模型（MongoDB Collections）

- **`restaurants`**
  - `{ _id, name, cuisine_tags[], rating, price_level, lat, lng, hours_json }`
- **`dishes`**
  - `{ _id, restaurant_id, name, desc, tags[], allergens[], price, lat, lng, image_url, popularity }`
- **`user_events`**
  - `{ _id, user_id, dish_id, like: -1|0|1, ts }`
- **`user_profiles`**
  - `{ _id, user_id, vector: [float], updated_at, liked_count }`

### API 接口

- `POST /api/auth/signup|login|logout` （邮箱/手机号，游客模式可选）
- `GET  /api/onboarding/dishes?limit=20` （抽取代表菜）
- `POST /api/user/feedback` （写入 user_events，实时更新画像）
- `GET  /api/recommend?lat&lng&budget&radius&allergens` （向量检索 + 过滤 + MMR，返回推荐理由）
- `GET  /api/restaurant/:id` （餐厅信息 + 推荐菜）
- `GET  /api/me/usage` （每日剩余推荐次数）

---

## 4. Frontend App

### 技术栈

- **框架**：Vue3 + Vite + Naive UI
- **状态管理**：Pinia
- **通信**：Axios 封装，统一错误处理与 Loading 提示

### 核心页面

- **Login.vue**
  - 简单注册/登录（手机号/邮箱/游客模式），保存 token
- **OnboardingTaste.vue**
  - 展示 20 道代表菜，用户三态选择生成初始画像
- **Recommend.vue**
  - 推荐结果列表（含推荐理由），支持预算/距离/过敏原筛选，三态反馈按钮
- **Restaurant.vue**
  - 餐厅详情 + 推荐菜列表，显示距离与地图位置
- **AppLayout**
  - 公共布局（搜索、定位失败兜底输入）

---

## 5. DevOps

### 容器化

- 使用 **Docker Compose** 管理 4 个服务：
  - `frontend`（Vue）
  - `backend`（Express）
  - `vector`（FastAPI + FAISS）
  - `mongodb`

### 持久化

- MongoDB 数据卷
- FAISS 索引文件 `/vector/index.faiss`
- 索引元数据 `/vector/idmap.json`

### 部署方案

- **前端**：Vercel 部署
- **后端 + Vector Service + MongoDB**：Railway / Render / Docker Volume
- **CI/CD**：GitHub Actions，Push 即自动构建并部署

---

## 6. Product & Operations

### 1. 用户引导（Onboarding）

- 解决冷启动问题，让新用户在第一次使用时就能得到个性化推荐。
- 给用户展示一组“代表性菜品”（例如 20 道），选择“喜欢 / 一般 / 不喜欢”。
- 基于选择结果生成初始口味画像。

### 2. 推荐引擎

- 输入条件：用户画像 + 地理位置 + 预算 + 过敏原限制。
- 推荐逻辑：
  - 从向量检索获取候选结果。
  - 应用预算、距离、过敏原过滤。
  - 使用 MMR 保证结果相关性和多样性。

### 3. 餐厅详情页

- 展示餐厅基本信息：名字、地址、评分、均价、营业时间。
- 推荐菜列表，并附推荐理由。
- 显示餐厅距离与地图位置。
- 预留扩展功能：订位、外卖、优惠券、团购。

### 4. 用户反馈

- 在推荐结果中提供“喜欢 / 一般 / 不喜欢”的交互。
- 反馈写入 `user_events`，并触发用户画像更新。
- 推荐卡片的推荐理由可与反馈联动，避免重复推荐不喜欢的结果。
- 用户画像是动态更新的，推荐质量会随使用逐渐优化。

### 5. 基础账户系统

- 提供注册/登录（邮箱/手机号）。
- 每日免费使用次数限制（如每天 5 次推荐）。
- 保存用户画像和使用记录，跨设备保持一致体验。

### 6. 数据与监控

- 收集推荐点击率、餐厅转化率、用户反馈分布。
- 监控用户使用频率、留存情况。
- 技术监控：API 请求量、错误率、性能指标。
- 采用日志与 APM 工具（如 Grafana、Datadog）进行监控。

---

# 总结

该系统通过 **多语言语义理解 + 向量检索** 实现精准餐饮推荐，  
用 MongoDB 管理元数据，确保扩展性与实时响应，  
一周内可上线 MVP，具备快速验证市场的能力。
