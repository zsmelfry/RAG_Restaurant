# ADR: 菜品 Schema 多语言支持与向量生成策略

## 背景

平台数据源包含中/英/法/俄等多种语言的菜品信息。  
存在两个核心问题：

- **前端展示**：若直接用原始字段，用户会看到混杂的语言（例如中文用户看到 allergen `soy` 会懵）。
- **向量生成**：多语言描述如何进入 embedding，存在三种选择：
  - **方案 A**：只用主语言文本生成向量
  - **方案 B**：拼接所有语言描述生成向量
  - **方案 C**：为每种语言生成一条向量

需要明确数据 schema 与向量生成的最终方案。

---

## 决策

1. **Schema 层新增 `translations` 字段**

   - 结构：`{ lang_code: { name, desc, tags?, allergens? } }`
   - `name`、`desc` 必填；`tags`、`allergens` 为可选翻译映射。
   - 用于前端展示，保证用户看到熟悉的语言。
   - 底层字段 `tags/allergens/ingredients/cuisine/dict_codes` 继续保持英文规范化，用于检索与过滤。

2. **向量生成采用方案 A（只取主语言文本）**
   - 主语言优先级：`zh > en > fr`（可扩展）。
   - 向量输入拼接：`name + desc + tags + allergens`（其中 tags/allergens 使用英文规范化）。
   - 不拼接所有语言，也不为每种语言单独生成向量。

---

## 理由

### 关于 `translations`

- **用户体验**：不同语言用户都能看到熟悉的文本（例如中文用户看到“大豆”而不是 `soy`）。
- **数据一致性**：检索/过滤依赖英文规范化，不会因翻译差异而混乱。
- **可扩展性**：未来支持更多语言，只需在 `translations` 中增加对应键值。

### 关于方案 A

- **模型特性**：所用多语言模型（如 `multilingual-e5-large`）天然支持跨语言对齐，不需要拼接多语言。
- **避免稀释**：拼接多语言描述会增加冗余，embedding 语义被稀释，降低检索效果。
- **效率**：每道菜只存一条向量，存储和检索效率最高。
- **可维护性**：逻辑简单清晰，避免去重和重复结果。

### 放弃方案 B / C 的原因

- **方案 B（拼接所有语言）**：文本过长易截断，语义噪音多，弊大于利。
- **方案 C（多条向量）**：虽然 recall 强，但会带来重复结果，需要 dedup，增加存储与检索成本，不适合推荐场景。

---

## 影响

- **数据模型**：更新 `dish.schema.json`，新增 `translations` 字段。
- **前端展示**：通过 `translations[user_lang]` 渲染界面，缺失时 fallback → 英文。
- **Indexer**：向量生成时仅选主语言文本，不拼接多语言。
- **后续演进**：若未来做“多语言搜索引擎”，可再考虑方案 C。

---

## 状态

**Accepted** （MVP 阶段执行）
