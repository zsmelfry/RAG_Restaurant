# 技术白皮书（MVP 架构，无餐厅版本，Qdrant 方案）

---

## 1. Data & Ingestion

### 数据来源

- **菜品信息**：菜名、描述、标签、过敏原、价格、图片。

### 数据处理

- **清洗**：统一格式、去重、处理缺失字段。
- **规范化**：标签与过敏原映射成标准字典（多语言支持）。
- **拼接文本**：将 `name + desc + tags + allergens` 拼成语义输入。
- **批量嵌入**：调用 Python Indexer 生成菜品向量。
- **入库**：菜品元数据存入 MongoDB；向量写入 Qdrant 索引。

## 2. Vector Service

### 职责

- **嵌入生成**：调用模型（`bge-m3` / `multilingual-e5-large`）生成向量。
- **索引更新**：调用 Qdrant API 批量 upsert 菜品向量。
- **用户画像更新**：根据用户反馈重算 `user_profiles.vector`，回写 Mongo。
- **快照管理**：定期触发 Qdrant snapshot，保存到对象存储。

### 运行方式

- 通过任务队列或 Mongo 状态字段（`index_status=pending`）驱动。
- 仅提供 **内部 API** 或定时任务，不对外暴露搜索功能。

---

## 3. Backend Server（Node.js + qdrant-js）

### 技术栈

- **框架**：Express + TypeScript
- **数据库**：MongoDB（Mongoose ODM）
- **向量搜索**：直接使用 `qdrant-js`（gRPC 优先，REST 兜底）调用 Qdrant

### 数据模型（MongoDB）

- **`dishes`**  
  `{ _id, name, desc, tags[], allergens[], price, image_url, popularity, vector_ready, index_status }`
- **`user_events`**  
  `{ _id, user_id, dish_id, like: -1|0|1, ts }`
- **`user_profiles`**  
  `{ _id, user_id, vector: [float], updated_at, liked_count }`

### API 接口

- `POST /api/auth/signup|login|logout`
- `GET  /api/onboarding/dishes?limit=20`
- `POST /api/user/feedback` （写入 user_events，触发画像重算任务）
- `GET  /api/recommend?budget&allergens`
  - Node 后端通过 `qdrant-js` 查询 Qdrant
  - 查询时附带过滤条件（如 `must_not allergens=crustacean`）
  - 结果经 **MMR 去冗余** 和业务重排后返回
- `GET  /api/me/usage`（每日剩余推荐次数）

---

## 4. Frontend App

### 技术栈

- **框架**：Vue3 + Vite + Naive UI
- **状态管理**：Pinia
- **通信**：Axios 封装，统一错误处理与 Loading 提示

### 核心页面

- **Login.vue**
  - 简单注册/登录（手机号/邮箱/游客模式），保存 token
- **OnboardingTaste.vue**
  - 展示 20 道代表菜，用户三态选择生成初始画像
- **Recommend.vue**
  - 推荐结果列表（含推荐理由），支持预算/过敏原筛选，三态反馈按钮
  - 推荐理由中可能包含“相似推荐提示”（如：因为你喜欢麻辣牛肉 → 推荐泰式咖喱）
- **AppLayout**
  - 公共布局（搜索、兜底输入）

---

## 5. DevOps

### 容器化

- 使用 **Docker Compose** 管理 5 个服务：
  - `frontend`（Vue）
  - `backend`（Express）
  - `indexer`（Python）
  - `qdrant`（向量数据库）
  - `mongodb`

### 持久化

- MongoDB 数据卷
- Qdrant 索引快照（定期保存到对象存储）

### 部署方案

- **前端**：Vercel
- **后端 + Qdrant + MongoDB + Indexer**：Railway / Render / Docker
- **CI/CD**：GitHub Actions，Push 即自动构建并部署

---

## 6. Product & Operations

### 1. 用户引导（Onboarding）

- 解决冷启动问题，让新用户在第一次使用时就能得到个性化推荐。
- 给用户展示一组“代表性菜品”（例如 20 道），选择“喜欢 / 一般 / 不喜欢”。
- 基于选择结果生成初始口味画像。

### 2. 推荐引擎

- 输入条件：用户画像 + 预算 + 过敏原限制。
- 推荐逻辑：
  - 从向量检索获取候选结果。
  - 应用预算、过敏原过滤。
  - 使用 MMR 保证结果相关性和多样性。
  - 支持语义相似推荐，增强新鲜感。

### 3. 用户反馈

- 在推荐结果中提供“喜欢 / 一般 / 不喜欢”的交互。
- 反馈写入 `user_events`，并触发用户画像更新。
- 推荐卡片的推荐理由可与反馈联动，避免重复推荐不喜欢的结果。
- 用户画像是动态更新的，推荐质量会随使用逐渐优化。

### 4. 基础账户系统

- 提供注册/登录（邮箱/手机号）。
- 每日免费使用次数限制（如每天 5 次推荐）。
- 保存用户画像和使用记录，跨设备保持一致体验。

### 5. 数据与监控

- 收集推荐点击率、用户反馈分布。
- 监控用户使用频率、留存情况。
- 技术监控：API 请求量、错误率、性能指标。
- 采用日志与 APM 工具（如 Grafana、Datadog）进行监控。

## 7. Backoffice

### 目标

为管理员提供一个最小可用的后台，便于监控系统运行和用户行为，保证数据质量。

### 功能模块（MVP）

- **用户数据面板**

  - 新注册用户数（日/周趋势）
  - 日活跃用户数（DAU）
  - 用户反馈分布（喜欢 / 一般 / 不喜欢比例）

- **数据质量面板**

  - 菜品总数
  - 重复率、缺失率
  - 按批次展示数据导入成功/失败情况

- **推荐效果面板**

  - 推荐调用次数（总量 & 人均）
  - 推荐点击/反馈率

- **基础管理功能**
  - 查看某个用户画像向量 & 反馈记录（只读）
  - 支持按 user_id 搜索

### 技术方案

- **前端**：Vue3 + Vite（或直接使用 Metabase/Grafana 快速搭建）
- **鉴权**：仅允许管理员账号访问
- **数据源**：直接读取 MongoDB & 日志统计结果

---

# 总结

该系统通过 **多语言语义理解 + 向量检索** 实现精准菜品推荐，  
用 MongoDB 管理元数据，确保扩展性与实时响应，  
一周内可上线 MVP，具备快速验证市场的能力。
